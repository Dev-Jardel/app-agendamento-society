<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Society</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display.swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos (sem alterações) */
        .kanban-container::-webkit-scrollbar, .player-list-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .kanban-container::-webkit-scrollbar-track, .player-list-container::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
            border-radius: 10px;
        }
        .kanban-container::-webkit-scrollbar-thumb, .player-list-container::-webkit-scrollbar-thumb {
            background: #5ce1e6; /* custom-cyan */
            border-radius: 10px;
        }
        .kanban-container::-webkit-scrollbar-thumb:hover, .player-list-container::-webkit-scrollbar-thumb:hover {
            background: #4ab8bd;
        }
        .capitalize {
            text-transform: capitalize;
        }
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        #kanban-board {
            transition: opacity 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fading-out {
            opacity: 0;
        }
    </style>

    <script>
        // Configuração do Tailwind CSS (sem alterações)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'custom-cyan': '#5ce1e6',
                        'dark-bg': '#111827',
                        'dark-card': '#1f2937',
                        'dark-card-hover': '#374151',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-gray-200 font-sans antialiased">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Cabeçalho (sem alterações) -->
        <header class="bg-dark-card/50 backdrop-blur-sm sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i data-lucide="calendar-check" class="h-8 w-8 text-custom-cyan"></i>
                        <h1 class="ml-3 text-xl font-bold tracking-tight">Agendamento Society</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-medium text-gray-300">Cliente</span>
                        <label for="view-toggle" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" id="view-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-custom-cyan peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-custom-cyan"></div>
                        </label>
                        <span class="font-medium text-white">Gestor</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal (sem alterações na estrutura HTML) -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center justify-center mb-8">
                <button id="prev-week" class="flex items-center gap-2 p-2 rounded-lg hover:bg-dark-card transition-colors">
                    <i data-lucide="chevron-left" class="h-6 w-6"></i>
                    <span class="hidden sm:inline font-semibold">Semana Anterior</span>
                </button>
                <h2 id="week-display" class="text-xl sm:text-2xl font-semibold mx-4 sm:mx-8 w-64 text-center">Carregando...</h2>
                <button id="next-week" class="flex items-center gap-2 p-2 rounded-lg hover:bg-dark-card transition-colors">
                    <span class="hidden sm:inline font-semibold">Próxima Semana</span>
                    <i data-lucide="chevron-right" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <div class="relative max-w-sm mx-auto">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Pesquisar por dia da semana..." class="w-full bg-dark-card border border-gray-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-custom-cyan focus:border-custom-cyan transition-colors">
                </div>
            </div>
            <div id="next-event-dashboard" class="hidden mb-8 p-6 bg-dark-card rounded-xl max-w-4xl mx-auto border border-custom-cyan/50">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i data-lucide="bell-ring" class="h-6 w-6 mr-3 text-custom-cyan"></i>
                    Próximo Evento
                </h3>
                <div id="next-event-details">
                    <p class="text-gray-400">Nenhum agendamento futuro encontrado.</p>
                </div>
            </div>
            <div id="price-manager" class="hidden mb-8 p-6 bg-dark-card rounded-xl max-w-4xl mx-auto">
                <div class="flex justify-between items-center cursor-pointer" id="price-manager-header">
                    <h3 class="text-xl font-bold text-white">Gerenciar Preços</h3>
                    <button id="toggle-price-manager" class="p-1 rounded-full hover:bg-dark-card-hover">
                        <i data-lucide="chevron-up" class="h-6 w-6 transition-transform duration-300"></i>
                    </button>
                </div>
                <div id="price-manager-content" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-end transition-all duration-300">
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-300 mb-2">1. Selecione os dias</label>
                        <div id="day-selector" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-300 mb-2">2. Defina o intervalo de horários</label>
                        <div class="flex items-center gap-4">
                            <input type="time" id="start-time-input" class="w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                            <span class="text-gray-400">até</span>
                            <input type="time" id="end-time-input" class="w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                        </div>
                    </div>
                    <div class="flex gap-4 items-end">
                        <div class="flex-grow">
                             <label for="price-input" class="block text-sm font-medium text-gray-300 mb-2">3. Novo preço (R$)</label>
                            <input type="text" id="price-input" placeholder="150,00" class="w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                        </div>
                         <button id="apply-price-btn" class="flex-shrink-0 h-10 px-5 bg-custom-cyan text-black rounded-lg font-bold hover:bg-opacity-80 transition-colors">Aplicar</button>
                    </div>
                    <div class="lg:col-span-3 mt-4 pt-4 border-t border-gray-700">
                        <button id="integrate-payment-btn" class="w-full flex items-center justify-center gap-2 h-10 px-5 bg-transparent border-2 border-custom-cyan text-custom-cyan rounded-lg font-bold hover:bg-custom-cyan hover:text-black transition-colors">
                             <i data-lucide="credit-card" class="h-5 w-5"></i>
                            Integrar Meios de Pagamento
                        </button>
                    </div>
                </div>
            </div>
            <div id="kanban-board" class="kanban-container flex gap-4 overflow-x-auto pb-4"></div>
            <div id="team-sorter" class="mt-10 bg-dark-card rounded-xl p-6 max-w-4xl mx-auto">
                <div id="team-sorter-header" class="flex justify-between items-center cursor-pointer">
                    <h3 class="text-2xl font-bold text-white">Sorteio de Times</h3>
                    <button id="toggle-team-sorter" class="p-1 rounded-full hover:bg-dark-card-hover">
                        <i data-lucide="chevron-up" class="h-6 w-6 transition-transform duration-300"></i>
                    </button>
                </div>
                <div id="team-sorter-content" class="mt-6 transition-all duration-300">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-300">Nomes dos Jogadores</label>
                                    <button id="add-player-btn" title="Adicionar jogador" class="flex items-center gap-1 text-sm text-custom-cyan font-semibold hover:text-opacity-80">
                                        <i data-lucide="plus-circle" class="h-4 w-4"></i>
                                        Adicionar
                                    </button>
                                </div>
                                <div id="player-list-container" class="player-list-container space-y-2 max-h-[265px] overflow-y-auto p-1"></div>
                            </div>
                             <div>
                                <label for="players-per-team" class="block text-sm font-medium text-gray-300 mb-2">Jogadores de linha por time</label>
                                <select id="players-per-team" class="w-full bg-gray-900 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-custom-cyan focus:border-custom-cyan">
                                    <option value="4">4 jogadores</option>
                                    <option value="5" selected>5 jogadores</option>
                                    <option value="6">6 jogadores</option>
                                </select>
                            </div>
                            <button id="sort-teams-btn" class="w-full flex items-center justify-center gap-2 h-11 px-5 bg-custom-cyan text-black rounded-lg font-bold hover:bg-opacity-80 transition-colors">
                                <i data-lucide="shuffle" class="h-5 w-5"></i>
                                Sortear Times
                            </button>
                        </div>
                        <div class="bg-dark-bg/50 p-4 rounded-lg min-h-[300px]">
                             <h4 class="text-lg font-bold text-white text-center mb-4">Times Sorteados</h4>
                            <div id="team-results" class="grid grid-cols-2 gap-4">
                                <p class="text-gray-500 col-span-full text-center mt-8">Os times sorteados aparecerão aqui.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais (sem alterações na estrutura HTML) -->
    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-white mb-2">Confirmar Agendamento</h3>
            <p id="modal-details" class="text-gray-400 mb-6">Você está prestes a agendar um horário.</p>
            <fieldset class="mb-6">
                <legend class="block text-sm font-medium text-gray-300 mb-2">Tipo de Agendamento</legend>
                <div class="flex gap-4">
                    <div class="flex items-center">
                        <input id="booking-type-single" name="booking-type" type="radio" value="avulso" checked class="h-4 w-4 text-custom-cyan bg-gray-700 border-gray-600 focus:ring-custom-cyan focus:ring-2">
                        <label for="booking-type-single" class="ml-2 block text-sm text-gray-200">Avulso</label>
                    </div>
                    <div class="flex items-center">
                        <input id="booking-type-monthly" name="booking-type" type="radio" value="mensal" class="h-4 w-4 text-custom-cyan bg-gray-700 border-gray-600 focus:ring-custom-cyan focus:ring-2">
                        <label for="booking-type-monthly" class="ml-2 block text-sm text-gray-200">Mensal</label>
                    </div>
                </div>
            </fieldset>
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-300">Seu Nome</label>
                    <input type="text" id="name" name="name" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan transition-colors">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-300">Seu Telefone (WhatsApp)</label>
                    <input type="tel" id="phone" name="phone" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan transition-colors">
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="cancel-button" class="py-2 px-5 bg-dark-card-hover rounded-lg font-semibold hover:bg-gray-600 transition-colors">Cancelar</button>
                <button id="confirm-button" class="py-2 px-5 bg-custom-cyan text-black rounded-lg font-bold hover:bg-opacity-80 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="cancel-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-xl shadow-2xl p-8 w-full max-w-sm m-4 transform transition-all duration-300 scale-95 opacity-0">
            <h3 class="text-xl font-bold text-white mb-4">Confirmar Desistência</h3>
            <p class="text-gray-400 mb-6">Você tem certeza que deseja cancelar esta pré-reserva? O horário voltará a ficar disponível para outros.</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-decline-button" class="py-2 px-5 bg-dark-card-hover rounded-lg font-semibold hover:bg-gray-600 transition-colors">Voltar</button>
                <button id="cancel-confirm-button" class="py-2 px-5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors">Sim, Desistir</button>
            </div>
        </div>
    </div>
    <div id="manager-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="manager-modal-title" class="text-2xl font-bold text-white mb-2"></h3>
            <div id="manager-view-container">
                 <div id="manager-modal-details" class="text-gray-300 mb-6 space-y-2 border-t border-b border-gray-700 py-4"></div>
            </div>
            <div id="manager-form-container" class="hidden">
                 <p id="manager-form-details" class="text-gray-400 mb-6"></p>
                 <fieldset class="mb-6">
                    <legend class="block text-sm font-medium text-gray-300 mb-2">Tipo de Agendamento</legend>
                    <div class="flex gap-4">
                        <div class="flex items-center">
                            <input id="manager-booking-type-single" name="manager-booking-type" type="radio" value="avulso" checked class="h-4 w-4 text-custom-cyan bg-gray-700 border-gray-600 focus:ring-custom-cyan focus:ring-2">
                            <label for="manager-booking-type-single" class="ml-2 block text-sm text-gray-200">Avulso</label>
                        </div>
                        <div class="flex items-center">
                            <input id="manager-booking-type-monthly" name="manager-booking-type" type="radio" value="mensal" class="h-4 w-4 text-custom-cyan bg-gray-700 border-gray-600 focus:ring-custom-cyan focus:ring-2">
                            <label for="manager-booking-type-monthly" class="ml-2 block text-sm text-gray-200">Mensal</label>
                        </div>
                    </div>
                </fieldset>
                 <div class="space-y-4">
                    <div>
                        <label for="manager-name" class="block text-sm font-medium text-gray-300">Nome do Cliente</label>
                        <input type="text" id="manager-name" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan transition-colors">
                    </div>
                    <div>
                        <label for="manager-phone" class="block text-sm font-medium text-gray-300">Telefone do Cliente</label>
                        <input type="tel" id="manager-phone" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan transition-colors">
                    </div>
                </div>
            </div>
            <div id="manager-actions" class="mt-6 flex justify-end gap-4"></div>
        </div>
    </div>
    <div id="add-slot-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-white mb-2">Adicionar na Agenda</h3>
            <p id="add-slot-modal-details" class="text-gray-400 mb-6"></p>
            <fieldset class="mb-6">
                <legend class="block text-sm font-medium text-gray-300 mb-2">Tipo de Adição</legend>
                <div class="flex gap-4">
                    <div class="flex items-center">
                        <input id="add-type-slot" name="add-type" type="radio" value="slot" checked class="h-4 w-4 text-custom-cyan bg-gray-700 border-gray-600 focus:ring-custom-cyan focus:ring-2">
                        <label for="add-type-slot" class="ml-2 block text-sm text-gray-200">Horário Avulso</label>
                    </div>
                    <div class="flex items-center">
                        <input id="add-type-event" name="add-type" type="radio" value="event" class="h-4 w-4 text-custom-cyan bg-gray-700 border-gray-600 focus:ring-custom-cyan focus:ring-2">
                        <label for="add-type-event" class="ml-2 block text-sm text-gray-200">Evento</label>
                    </div>
                </div>
            </fieldset>
            <div id="slot-fields" class="space-y-4">
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label for="new-start-time" class="block text-sm font-medium text-gray-300">Início</label>
                        <input type="time" id="new-start-time" name="new-start-time" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                    </div>
                    <div class="w-1/2">
                        <label for="new-end-time" class="block text-sm font-medium text-gray-300">Fim</label>
                        <input type="time" id="new-end-time" name="new-end-time" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                    </div>
                </div>
                <div>
                    <label for="new-price" class="block text-sm font-medium text-gray-300">Preço (R$)</label>
                    <input type="text" id="new-price" name="new-price" placeholder="150,00" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                </div>
                <div class="flex items-start pt-2">
                    <div class="flex items-center h-5">
                        <input id="is-monthly-slot" name="is-monthly-slot" type="checkbox" class="focus:ring-custom-cyan h-4 w-4 text-custom-cyan bg-gray-800 border-gray-600 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="is-monthly-slot" class="font-medium text-gray-300">Tornar este horário fixo (mensal)</label>
                    </div>
                </div>
            </div>
            <div id="event-fields" class="space-y-4 hidden">
                 <div>
                    <label for="event-name" class="block text-sm font-medium text-gray-300">Nome do Evento</label>
                    <input type="text" id="event-name" name="event-name" placeholder="Ex: Campeonato de Verão" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                </div>
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label for="event-start-time" class="block text-sm font-medium text-gray-300">Início</label>
                        <input type="time" id="event-start-time" name="event-start-time" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                    </div>
                    <div class="w-1/2">
                        <label for="event-end-time" class="block text-sm font-medium text-gray-300">Fim</label>
                        <input type="time" id="event-end-time" name="event-end-time" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                    </div>
                </div>
                <div class="flex items-start pt-2">
                    <div class="flex items-center h-5">
                        <input id="field-in-use" name="field-in-use" type="checkbox" class="focus:ring-custom-cyan h-4 w-4 text-custom-cyan bg-gray-800 border-gray-600 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="field-in-use" class="font-medium text-gray-300">O campo será utilizado para jogos?</label>
                        <p class="text-gray-500">Se marcado, os horários neste período ficarão indisponíveis.</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="cancel-add-slot-button" class="py-2 px-5 bg-dark-card-hover rounded-lg font-semibold hover:bg-gray-600 transition-colors">Cancelar</button>
                <button id="confirm-add-slot-button" class="py-2 px-5 bg-custom-cyan text-black rounded-lg font-bold hover:bg-opacity-80 transition-colors">Adicionar</button>
            </div>
        </div>
    </div>
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card rounded-xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-white mb-2">Integrar Meios de Pagamento</h3>
            <p class="text-gray-400 mb-6">Configure uma integração para receber pagamentos via PIX ou cartão.</p>
            <div class="space-y-4">
                 <div>
                    <label for="payment-provider" class="block text-sm font-medium text-gray-300">Provedor</label>
                    <select id="payment-provider" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                        <option>Nubank</option>
                        <option>PicPay</option>
                        <option>Inter</option>
                        <option>Mercado Pago</option>
                    </select>
                </div>
                <div>
                    <label for="payment-credential-1" class="block text-sm font-medium text-gray-300">Chave PIX / Client ID</label>
                    <input type="text" id="payment-credential-1" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                </div>
                 <div>
                    <label for="payment-credential-2" class="block text-sm font-medium text-gray-300">Client Secret (Opcional)</label>
                    <input type="password" id="payment-credential-2" class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-custom-cyan focus:border-custom-cyan">
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="cancel-payment-button" class="py-2 px-5 bg-dark-card-hover rounded-lg font-semibold hover:bg-gray-600 transition-colors">Cancelar</button>
                <button id="connect-payment-button" class="py-2 px-5 bg-custom-cyan text-black rounded-lg font-bold hover:bg-opacity-80 transition-colors">Conectar</button>
            </div>
        </div>
    </div>
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-dark-card border-custom-cyan text-white p-4 rounded-lg shadow-lg flex items-center gap-4 max-w-sm transition-all duration-500 transform translate-x-[calc(100%+20px)] opacity-0 z-50">
        <div id="toast-icon"></div>
        <p id="toast-message" class="text-sm"></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot,
            setDoc,
            updateDoc,
            deleteDoc,
            addDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // SUA CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDcY1-29jWmbnpBDePgAmJfWhr79Nsl7Ug",
            authDomain: "gestor-futebol-app.firebaseapp.com",
            projectId: "gestor-futebol-app",
            storageBucket: "gestor-futebol-app.appspot.com",
            messagingSenderId: "643691351263",
            appId: "1:643691351263:web:6ad71343afed3a0305ad6a",
            measurementId: "G-BZQ57SN00Q"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da UI (sem alterações)
            const weekDisplay = document.getElementById('week-display');
            const kanbanBoard = document.getElementById('kanban-board');
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const searchInput = document.getElementById('search-input');
            const viewToggle = document.getElementById('view-toggle');
            const bookingModal = document.getElementById('booking-modal');
            const bookingModalContent = bookingModal.querySelector('div');
            const modalDetails = document.getElementById('modal-details');
            const cancelButton = document.getElementById('cancel-button');
            const confirmButton = document.getElementById('confirm-button');
            const cancelConfirmModal = document.getElementById('cancel-confirm-modal');
            const cancelConfirmModalContent = cancelConfirmModal.querySelector('div');
            const cancelDeclineButton = document.getElementById('cancel-decline-button');
            const cancelConfirmButton = document.getElementById('cancel-confirm-button');
            const managerModal = document.getElementById('manager-modal');
            const managerModalContent = managerModal.querySelector('.bg-dark-card');
            const addSlotModal = document.getElementById('add-slot-modal');
            const addSlotModalContent = addSlotModal.querySelector('div');
            const addSlotModalDetails = document.getElementById('add-slot-modal-details');
            const cancelAddSlotButton = document.getElementById('cancel-add-slot-button');
            const confirmAddSlotButton = document.getElementById('confirm-add-slot-button');
            const addTypeSlotRadio = document.getElementById('add-type-slot');
            const addTypeEventRadio = document.getElementById('add-type-event');
            const slotFields = document.getElementById('slot-fields');
            const eventFields = document.getElementById('event-fields');
            const paymentModal = document.getElementById('payment-modal');
            const paymentModalContent = paymentModal.querySelector('div');
            const integratePaymentBtn = document.getElementById('integrate-payment-btn');
            const cancelPaymentBtn = document.getElementById('cancel-payment-button');
            const connectPaymentBtn = document.getElementById('connect-payment-button');
            const priceManagerContainer = document.getElementById('price-manager');
            const priceManagerHeader = document.getElementById('price-manager-header');
            const priceManagerContent = document.getElementById('price-manager-content');
            const togglePriceManagerBtn = document.getElementById('toggle-price-manager');
            const teamSorter = document.getElementById('team-sorter');
            const teamSorterHeader = document.getElementById('team-sorter-header');
            const teamSorterContent = document.getElementById('team-sorter-content');
            const toggleTeamSorterBtn = document.getElementById('toggle-team-sorter');
            const playerListContainer = document.getElementById('player-list-container');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const sortTeamsBtn = document.getElementById('sort-teams-btn');
            const teamResults = document.getElementById('team-results');
            const nextEventDashboard = document.getElementById('next-event-dashboard');
            const nextEventDetails = document.getElementById('next-event-details');
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            const clientPhoneInput = document.getElementById('phone');
            const managerPhoneInput = document.getElementById('manager-phone');
            
            // Estado da Aplicação
            const todayStr = formatFullDate(new Date());
            let currentWeekStart = getMonday(new Date());
            let currentBookingData = null; 
            let currentSlotAddData = null;
            let currentCancellationSlotId = null;
            let isManagerView = false;
            let dashboardInterval = null;
            let currentUser = null; 
            let firebaseReady = false;

            // Dados vindos do Firebase
            let schedules = {}; 
            let monthlySchedules = {}; 
            let events = {};
            let priceRules = {}; 

            // Constantes
            const dayNames = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
            const defaultTimeSlots = ['18:00 - 19:00', '19:00 - 20:00', '20:00 - 21:00', '21:00 - 22:00', '22:00 - 23:00'];

            // --- INICIALIZAÇÃO E AUTENTICAÇÃO FIREBASE ---
            async function initFirebase() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        setupFirestoreListeners();
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Erro no login anônimo:", error);
                        });
                    }
                });
            }

            // --- LISTENERS DO FIRESTORE ---
            function setupFirestoreListeners() {
                onSnapshot(collection(db, 'schedules'), (snapshot) => {
                    const remoteSchedules = {};
                    snapshot.forEach(doc => {
                        remoteSchedules[doc.id] = doc.data();
                    });
                    schedules = remoteSchedules;
                    if(firebaseReady) renderBasedOnCurrentView();
                });

                onSnapshot(collection(db, 'monthlySchedules'), (snapshot) => {
                    const remoteMonthly = {};
                    snapshot.forEach(doc => {
                        remoteMonthly[doc.id] = doc.data();
                    });
                    monthlySchedules = remoteMonthly;
                    if(firebaseReady) renderBasedOnCurrentView();
                });

                onSnapshot(doc(db, 'configurations', 'priceRules'), (docSnap) => {
                    if (docSnap.exists()) {
                        priceRules = docSnap.data();
                    } else {
                        priceRules = {
                            default: {
                                '18:00 - 19:00': '150,00', '19:00 - 20:00': '150,00',
                                '20:00 - 21:00': '180,00', '21:00 - 22:00': '180,00',
                                '22:00 - 23:00': '120,00'
                            }
                        };
                    }
                    firebaseReady = true;
                    renderBasedOnCurrentView();
                });
            }

            // Funções Utilitárias (sem alterações)
            const applyPhoneMask = (event) => {
                const input = event.target;
                let value = input.value.replace(/\D/g, '');
                value = value.substring(0, 11);
                
                if (value.length > 7) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 3)} ${value.substring(3, 7)}-${value.substring(7, 11)}`;
                } else if (value.length > 3) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 3)} ${value.substring(3, 7)}`;
                } else if (value.length > 2) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 3)}`;
                } else if (value.length > 0) {
                    value = `(${value.substring(0, 2)}`;
                }
                
                input.value = value;
            };
            function getMonday(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }
            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}/${month}`;
            }
            function formatFullDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            function getPrice(fullDateStr, dayName, time) {
                const monthlyKey = `${dayName}_${time}`;
                const monthlySchedule = Object.values(monthlySchedules).find(ms => ms.dayName === dayName && ms.time === time);
                if (monthlySchedule) return monthlySchedule.price;

                if (priceRules[fullDateStr] && priceRules[fullDateStr][time]) return priceRules[fullDateStr][time];
                if (priceRules[dayName] && priceRules[dayName][time]) return priceRules[dayName][time];
                return (priceRules.default && priceRules.default[time]) || '0,00';
            }
            function checkExpiredReservations() {
                const now = new Date().getTime();
                for (const slotId in schedules) {
                    const booking = schedules[slotId];
                    if (booking.status === 'pending' && booking.expiresAt && now > booking.expiresAt.toDate().getTime()) {
                        deleteDoc(doc(db, 'schedules', slotId));
                    }
                }
            }
             function findMonthlyBooking(slotId) {
                const [date, time] = slotId.split('_');
                const dayDate = new Date(date + 'T12:00:00Z');
                const dayName = dayNames[dayDate.getUTCDay()];
                
                const monthlyKey = Object.keys(monthlySchedules).find(key => {
                    const schedule = monthlySchedules[key];
                    return schedule.dayName === dayName && schedule.time === time;
                });

                return monthlyKey ? { ...monthlySchedules[monthlyKey], slotId: slotId, status: 'booked' } : null;
            }
            function renderBasedOnCurrentView() {
                if (!firebaseReady) return; 
                const searchTerm = searchInput.value;
                 if (searchTerm) {
                    renderFilteredDays(searchTerm);
                } else {
                    renderWeek();
                }
                if (isManagerView) updateNextEventDashboard();
            }
            
            function showToast(message, isSuccess = true) {
                toastMessage.textContent = message;
                if(isSuccess) {
                    toastIcon.innerHTML = `<i data-lucide="check-circle" class="h-6 w-6 text-custom-cyan flex-shrink-0"></i>`;
                    toastNotification.classList.remove('border-red-500');
                    toastNotification.classList.add('border-custom-cyan');
                } else {
                    toastIcon.innerHTML = `<i data-lucide="alert-triangle" class="h-6 w-6 text-red-500 flex-shrink-0"></i>`;
                    toastNotification.classList.remove('border-custom-cyan');
                    toastNotification.classList.add('border-red-500');
                }
                lucide.createIcons();
                toastNotification.classList.remove('translate-x-[calc(100%+20px)]', 'opacity-0');
                setTimeout(() => {
                    toastNotification.classList.add('translate-x-[calc(100%+20px)]', 'opacity-0')
                }, 5000);
            }

            // --- Lógica de Renderização (COM NOVA LÓGICA DE STATUS) ---
            function createDayColumn(dayDate) {
                const fullDateStr = formatFullDate(dayDate);
                const dayIndex = dayDate.getDay();
                const dayName = dayNames[dayIndex];
                const isToday = fullDateStr === todayStr;
                
                const column = document.createElement('div');
                column.className = 'day-column w-72 md:w-80 flex-shrink-0 bg-dark-card rounded-xl shadow-lg border-2';
                column.classList.add(isToday ? 'border-custom-cyan' : 'border-transparent');
                
                let slotsForDay = new Set(defaultTimeSlots);
                Object.values(priceRules).forEach(dayRule => {
                    Object.keys(dayRule).forEach(time => slotsForDay.add(time));
                });
                
                const sortedSlots = Array.from(slotsForDay).sort();

                const timeSlotsHtml = sortedSlots.map(slot => {
                    const slotId = `${fullDateStr}_${slot}`;
                    const singleBooking = schedules[slotId];
                    const monthlyBooking = findMonthlyBooking(slotId);
                    const price = getPrice(fullDateStr, dayName, slot);
                    
                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    const slotDate = new Date(dayDate); slotDate.setHours(0, 0, 0, 0);
                    const isPast = slotDate < today;
                    const booking = singleBooking || monthlyBooking;

                    if (isManagerView) {
                        let content = `<span class="text-custom-cyan font-bold">Agendar</span>`;
                        let buttonClass = 'bg-dark-card-hover hover:opacity-70';

                        if (booking) {
                            let clientInfo = `<p class="text-sm text-gray-300 mt-1 truncate">${booking.clientName || 'N/A'}</p>`;
                            if (booking.status === 'pending') {
                                buttonClass = 'bg-yellow-900/60 hover:bg-yellow-800/80 border border-yellow-500/50';
                                content = `<span class="text-xs font-medium text-yellow-300">Aguardando Pagamento</span>${clientInfo}`;
                            } else if (booking.status === 'payment_review') { // NOVO STATUS
                                buttonClass = 'bg-blue-900/60 hover:bg-blue-800/80 border border-blue-500/50';
                                content = `<span class="text-xs font-medium text-blue-300">Revisar Pagamento</span>${clientInfo}`;
                            }
                            else { 
                                buttonClass = 'bg-green-900/60 hover:bg-green-800/80 border border-green-500/50';
                                content = `<span class="text-xs font-medium text-green-300">${booking.type === 'event' ? 'Evento' : 'Confirmado'}</span>${clientInfo}`;
                            }
                        } else if(isPast) {
                            buttonClass = 'bg-gray-900/50 hover:opacity-70';
                            content = `<span class="text-gray-500 font-bold">Agendar (Passado)</span>`;
                        }
                        
                        return `
                            <button class="w-full text-left p-3 rounded-lg ${buttonClass} transition-colors"
                                data-slot-id="${slotId}" data-is-manager-button="true"
                                data-day="${dayName}" data-date="${formatDate(dayDate)}" data-time="${slot}" data-price="${price}">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-white">${slot}</span>
                                    <span class="text-sm font-medium text-gray-400">R$ ${price}</span>
                                </div>
                                ${content}
                            </button>`;
                    } else {
                        let status = isPast ? 'past' : (booking ? booking.status : 'available');
                        let buttonHtml;
                        
                        if (status === 'past') {
                            buttonHtml = `<button disabled class="w-full text-left p-3 rounded-lg bg-gray-900/50 cursor-not-allowed"><div class="flex justify-between items-center"><span class="font-semibold text-gray-600">${slot}</span><span class="text-xs font-medium text-gray-500">Encerrado</span></div></button>`;
                        } else if (status === 'booked') {
                             buttonHtml = `<button disabled class="w-full text-left p-3 rounded-lg bg-gray-900/50 cursor-not-allowed"><div class="flex justify-between items-center"><span class="font-semibold text-gray-500">${slot}</span><span class="text-xs font-medium text-red-400">Reservado</span></div></button>`;
                        } else if (status === 'pending' || status === 'payment_review') { // AGRUPA OS DOIS ESTADOS
                            if (currentUser && booking.userId === currentUser.uid) { 
                                if (status === 'pending') {
                                    // NOVO: BOTÃO "JÁ PAGUEI" AO LADO DO "DESISTIR"
                                    buttonHtml = `<div class="w-full text-left p-2 rounded-lg bg-yellow-900/60 border border-yellow-500/50">
                                        <div class="flex justify-between items-center mb-2 px-1">
                                            <span class="font-semibold text-yellow-300">${slot}</span>
                                            <span class="text-xs font-medium text-yellow-200">Aguardando Pagamento</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mt-1">
                                            <button class="w-full text-center py-1 rounded-md bg-red-600/80 hover:bg-red-600 text-white text-xs font-bold" data-slot-id="${slotId}" data-action="cancel-my-booking">Desistir</button>
                                            <button class="w-full text-center py-1 rounded-md bg-green-600/80 hover:bg-green-600 text-white text-xs font-bold" data-slot-id="${slotId}" data-action="notify-payment">Já Paguei</button>
                                        </div>
                                    </div>`;
                                } else { // status === 'payment_review'
                                    buttonHtml = `<button disabled class="w-full text-left p-3 rounded-lg bg-blue-900/60 border border-blue-500/50"><div class="flex justify-between items-center"><span class="font-semibold text-blue-300">${slot}</span><span class="text-xs font-medium text-blue-200">Pagamento em revisão</span></div></button>`;
                                }
                            } else {
                                 buttonHtml = `<button disabled class="w-full text-left p-3 rounded-lg bg-yellow-900/40 border border-yellow-500/50 cursor-not-allowed"><div class="flex justify-between items-center"><span class="font-semibold text-yellow-400">${slot}</span><span class="text-xs font-medium text-yellow-400">Aguardando Pagamento</span></div></button>`;
                            }
                        } else { // available
                             buttonHtml = `<button class="w-full text-left p-3 rounded-lg bg-dark-card-hover hover:bg-custom-cyan hover:text-black transition-all duration-200" data-day="${dayName}" data-date="${formatDate(dayDate)}" data-time="${slot}" data-price="${price}" data-slot-id="${slotId}"><div class="flex justify-between items-center"><span class="font-semibold text-gray-200">${slot}</span><span class="text-custom-cyan font-bold">R$ ${price}</span></div></button>`;
                        }
                        
                        return buttonHtml;
                    }
                }).join('');
                
                const managerToolsHtml = isManagerView ? `<button class="p-1 rounded-full hover:bg-dark-card-hover add-timeslot-btn" data-date="${fullDateStr}"><i data-lucide="plus-circle" class="h-5 w-5 text-custom-cyan"></i></button>` : '';
                const todayLabelHtml = isToday ? `<span class="text-xs font-bold bg-custom-cyan text-black px-2 py-1 rounded-full">HOJE</span>` : '';

                column.innerHTML = `
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <div><h3 class="font-bold text-lg text-white">${dayName}</h3><p class="text-sm text-gray-400">${formatDate(dayDate)}</p></div>
                        <div class="flex items-center gap-2">${todayLabelHtml}${managerToolsHtml}</div>
                    </div>
                    <div class="p-4 space-y-3 h-[60vh] overflow-y-auto">${timeSlotsHtml}</div>`;
                return column;
            }

            function attachColumnListeners() {
                 kanbanBoard.querySelectorAll('button[data-slot-id]').forEach(button => {
                    if (button.dataset.isManagerButton === 'true') {
                        button.addEventListener('click', (e) => {
                            const { slotId, day, date, time, price } = e.currentTarget.dataset;
                            openManagerModal({ slotId, day, date, time, price });
                        });
                    } else if (!button.disabled) {
                        const action = button.dataset.action;
                        if (action === 'cancel-my-booking') {
                             button.addEventListener('click', (e) => {
                                const slotId = e.currentTarget.dataset.slotId;
                                openCancelConfirmModal(slotId);
                            });
                        } else if (action === 'notify-payment') { // NOVA AÇÃO
                            button.addEventListener('click', (e) => {
                                const slotId = e.currentTarget.dataset.slotId;
                                handleClientPaymentNotification(slotId);
                            });
                        } else {
                            button.addEventListener('click', (e) => {
                                const { day, date, time, price, slotId } = e.currentTarget.dataset;
                                openModal({ day, date, time, price, slotId });
                            });
                        }
                    }
                });
                kanbanBoard.querySelectorAll('.add-timeslot-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const date = e.currentTarget.dataset.date;
                        openAddSlotModal(date);
                    });
                });
            }
            function renderWeek() {
                kanbanBoard.innerHTML = '';
                const weekStart = new Date(currentWeekStart);
                const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate() + 6);
                weekDisplay.textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(weekStart); dayDate.setDate(dayDate.getDate() + i);
                    kanbanBoard.appendChild(createDayColumn(dayDate));
                }
                lucide.createIcons();
                attachColumnListeners();
            }
            function renderFilteredDays(searchTerm) {
                kanbanBoard.innerHTML = '';
                const normSearch = searchTerm.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if (!normSearch) {
                    prevWeekBtn.style.visibility = 'visible'; nextWeekBtn.style.visibility = 'visible';
                    renderWeek(); return;
                }
                const matchDay = dayNames.find(d => d.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").startsWith(normSearch));
                if (!matchDay) {
                    kanbanBoard.innerHTML = '<p class="text-center text-gray-400 w-full">Nenhum dia da semana encontrado.</p>'; return;
                }
                const dayIndex = dayNames.indexOf(matchDay);
                weekDisplay.textContent = `Exibindo próximas: ${matchDay}s`;
                prevWeekBtn.style.visibility = 'hidden'; nextWeekBtn.style.visibility = 'hidden';
                let firstDay = new Date();
                while (firstDay.getDay() !== dayIndex) { firstDay.setDate(firstDay.getDate() + 1); }
                for (let i = 0; i < 8; i++) {
                    const dayDate = new Date(firstDay); dayDate.setDate(dayDate.getDate() + (i * 7));
                    kanbanBoard.appendChild(createDayColumn(dayDate));
                }
                lucide.createIcons();
                attachColumnListeners();
            }
            function openModal(data) {
                currentBookingData = data;
                modalDetails.innerHTML = `<span class="font-bold text-white">${data.day}, ${data.date}</span><br>Horário: ${data.time}<br>Valor: <span class="font-bold text-custom-cyan">R$ ${data.price}</span>`;
                bookingModal.classList.remove('hidden');
                setTimeout(() => bookingModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }
            function closeModal() {
                bookingModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    bookingModal.classList.add('hidden');
                    document.getElementById('name').value = ''; document.getElementById('phone').value = '';
                    currentBookingData = null;
                }, 200);
            }
            function openCancelConfirmModal(slotId) {
                currentCancellationSlotId = slotId;
                cancelConfirmModal.classList.remove('hidden');
                setTimeout(() => cancelConfirmModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }
            function closeCancelConfirmModal() {
                cancelConfirmModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    cancelConfirmModal.classList.add('hidden');
                    currentCancellationSlotId = null;
                }, 200);
            }
            function openManagerModal(data) {
                const { slotId, day, date, time, price } = data;
                const booking = schedules[slotId] || findMonthlyBooking(slotId);

                const titleEl = document.getElementById('manager-modal-title');
                const viewContainer = document.getElementById('manager-view-container');
                const formContainer = document.getElementById('manager-form-container');
                const actionsDiv = document.getElementById('manager-actions');
                
                actionsDiv.innerHTML = ''; 

                if (booking) {
                    titleEl.textContent = 'Detalhes do Agendamento';
                    viewContainer.classList.remove('hidden'); formContainer.classList.add('hidden');
                    const detailsDiv = document.getElementById('manager-modal-details');
                    
                    const rawPhone = (booking.clientPhone || '').replace(/\D/g, '');
                    const whatsappLink = rawPhone ? `https://wa.me/55${rawPhone}` : '#';

                    detailsDiv.innerHTML = `
                        <p><strong>Horário:</strong> ${day}, ${date} às ${time}</p>
                        <p><strong>Cliente:</strong> ${booking.clientName || 'N/A'}</p>
                        <div class="flex items-center">
                            <p class="flex-grow"><strong>Telefone:</strong> ${booking.clientPhone || 'N/A'}</p>
                            ${rawPhone ? `<a href="${whatsappLink}" target="_blank" rel="noopener noreferrer" class="ml-4 flex-shrink-0 inline-flex items-center justify-center h-8 w-8 rounded-full bg-green-500 hover:bg-green-600 transition-colors" title="Abrir no WhatsApp"><i data-lucide="message-square" class="h-4 w-4 text-white"></i></a>` : ''}
                        </div>
                        <p><strong>Tipo:</strong> <span class="capitalize">${booking.type}</span></p>
                        <p><strong>Status:</strong> <span class="capitalize">${(booking.status || '').replace('_', ' ')}</span></p>
                        <p><strong>Valor:</strong> R$ ${price}</p>`;

                    if (booking.status === 'pending' || booking.status === 'payment_review') {
                        actionsDiv.innerHTML += `<button onclick="confirmPayment('${slotId}', '${price}')" class="py-2 px-5 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors">Confirmar Pagamento</button>`;
                    }
                    actionsDiv.innerHTML += `<button onclick="cancelBooking('${slotId}')" class="py-2 px-5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors">Cancelar Agendamento</button>`;
                } else {
                    titleEl.textContent = 'Agendar Horário para Cliente';
                    viewContainer.classList.add('hidden'); formContainer.classList.remove('hidden');
                    document.getElementById('manager-form-details').innerHTML = `Agendando para <span class="font-bold text-white">${day}, ${date}</span> às <span class="font-bold text-white">${time}</span>.`;
                    document.getElementById('manager-name').value = '';
                    document.getElementById('manager-phone').value = '';
                    document.getElementById('manager-booking-type-single').checked = true;
                    actionsDiv.innerHTML += `<button onclick="createBookingByManager('${slotId}', '${price}')" class="py-2 px-5 bg-custom-cyan text-black rounded-lg font-bold hover:bg-opacity-80 transition-colors">Salvar Agendamento</button>`;
                }

                actionsDiv.innerHTML += `<button onclick="closeManagerModal()" class="py-2 px-5 bg-dark-card-hover rounded-lg font-semibold hover:bg-gray-600 transition-colors">Fechar</button>`;
                managerModal.classList.remove('hidden');
                setTimeout(() => {
                    managerModalContent.classList.remove('scale-95', 'opacity-0');
                    lucide.createIcons();
                }, 10);
            }
            window.closeManagerModal = () => {
                managerModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => managerModal.classList.add('hidden'), 200);
            }
            function openAddSlotModal(date) { /* ... (sem alterações) ... */ }
            function closeAddSlotModal() { /* ... (sem alterações) ... */ }
            function openPaymentModal() { /* ... (sem alterações) ... */ }
            function closePaymentModal() { /* ... (sem alterações) ... */ }
            
            // NOVA FUNÇÃO: Manipula a notificação de pagamento do cliente
            async function handleClientPaymentNotification(slotId) {
                const booking = schedules[slotId];
                if (booking && booking.userId === currentUser.uid && booking.status === 'pending') {
                    try {
                        await updateDoc(doc(db, 'schedules', slotId), {
                            status: 'payment_review'
                        });
                        showToast("Aviso de pagamento enviado! O gestor irá confirmar em breve.");
                    } catch (e) {
                        console.error("Erro ao notificar pagamento:", e);
                        showToast("Não foi possível notificar o pagamento.", false);
                    }
                }
            }


            // --- AÇÕES DO GESTOR ---
            window.createBookingByManager = async (slotId, price) => {
                const name = document.getElementById('manager-name').value;
                const phone = document.getElementById('manager-phone').value;
                const type = document.querySelector('input[name="manager-booking-type"]:checked').value;
                if (!name || !phone) { return; } 

                const [date, time] = slotId.split('_');
                const dayDate = new Date(date + 'T12:00:00Z');
                const dayName = dayNames[dayDate.getUTCDay()];

                try {
                    if (type === 'mensal') {
                        const monthlyKey = `${dayName}_${time}`;
                        await setDoc(doc(db, 'monthlySchedules', monthlyKey), { 
                            clientName: name, clientPhone: phone, type: 'mensal', time, dayName, price
                        });
                        showToast("Agendamento mensal salvo!");
                    } else {
                        await setDoc(doc(db, 'schedules', slotId), { 
                            clientName: name, clientPhone: phone, type: 'avulso', status: 'booked', price
                        });
                         showToast("Agendamento salvo!");
                    }
                } catch(e) {
                    console.error("Erro ao salvar agendamento: ", e);
                    showToast("Erro ao salvar agendamento.", false);
                }
                closeManagerModal();
            };

            window.confirmPayment = async (slotId, price) => {
                const booking = schedules[slotId];
                if (!booking || (booking.status !== 'pending' && booking.status !== 'payment_review')) return;

                const numericPrice = parseFloat(price.replace('.', '').replace(',', '.'));
                
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;

                try {
                    await addDoc(collection(db, "transacoes"), {
                        valor: numericPrice,
                        descricao: `Aluguer de horário: ${booking.clientName} (${slotId})`,
                        data: formattedDate,
                        tipo: 'Receita'
                    });

                    await updateDoc(doc(db, 'schedules', slotId), {
                        status: 'booked'
                    });

                    showToast("Pagamento confirmado e lançado no financeiro!");
                    closeManagerModal();
                } catch (error) {
                    console.error("Erro ao confirmar pagamento: ", error);
                    showToast("Ocorreu um erro. Tente novamente.", false);
                }
            }

            window.cancelBooking = async (slotId) => {
                const singleBooking = schedules[slotId];
                const monthlyBooking = !singleBooking ? findMonthlyBooking(slotId) : null;
                
                try {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const formattedDate = `${year}-${month}-${day}`;

                    if (singleBooking && (singleBooking.status === 'booked' || singleBooking.status === 'payment_review')) {
                        const numericPrice = parseFloat(String(singleBooking.price || '0').replace('.', '').replace(',', '.'));
                        await addDoc(collection(db, "transacoes"), {
                            valor: numericPrice,
                            descricao: `Cancelamento/Estorno: ${singleBooking.clientName} (${slotId})`,
                            data: formattedDate,
                            tipo: 'Despesa' 
                        });
                    }
                    
                    if (monthlyBooking) {
                         const numericPrice = parseFloat(String(monthlyBooking.price || '0').replace('.', '').replace(',', '.'));
                         await addDoc(collection(db, "transacoes"), {
                            valor: numericPrice,
                            descricao: `Cancelamento Fixo/Estorno: ${monthlyBooking.clientName} (${monthlyBooking.dayName} ${monthlyBooking.time})`,
                            data: formattedDate,
                            tipo: 'Despesa' 
                        });
                    }

                    if (singleBooking) { 
                        await deleteDoc(doc(db, 'schedules', slotId));
                    } else if (monthlyBooking) {
                        const [date, time] = slotId.split('_');
                        const dayDate = new Date(date + 'T12:00:00Z');
                        const dayName = dayNames[dayDate.getUTCDay()];
                        const monthlyKey = `${dayName}_${time}`;
                        await deleteDoc(doc(db, 'monthlySchedules', monthlyKey));
                    }
                    
                    showToast("Agendamento cancelado e estorno lançado, se aplicável.");
                } catch(e) {
                    console.error("Erro ao cancelar: ", e);
                    showToast("Erro ao cancelar agendamento.", false);
                }
                
                closeManagerModal();
            }

            // Lógica do Dashboard e outras funções (sem alterações)...
            function updateNextEventDashboard() { /* ... */ }
            async function initPriceManager() { /* ... */ }
            function addPlayerInput() { /* ... */ }
            function updatePlayerPlaceholders() { /* ... */ }
            
            // Event Listeners
            const navigateWeek = (direction) => { /* ... */ };
            prevWeekBtn.addEventListener('click', () => navigateWeek('prev'));
            nextWeekBtn.addEventListener('click', () => navigateWeek('next'));
            cancelButton.addEventListener('click', closeModal);
            bookingModal.addEventListener('click', e => { if (e.target === bookingModal) closeModal(); });
            managerModal.addEventListener('click', e => { if (e.target === managerModal) closeManagerModal(); });
            clientPhoneInput.addEventListener('input', applyPhoneMask);
            managerPhoneInput.addEventListener('input', applyPhoneMask);

            confirmButton.addEventListener('click', async () => {
                if (!currentBookingData || !currentUser) return;
                const nameInput = document.getElementById('name'); const phoneInput = document.getElementById('phone');
                if (!nameInput.value || !phoneInput.value) { return; }

                const bookingType = document.querySelector('input[name="booking-type"]:checked').value;
                const expiresDate = new Date();
                expiresDate.setHours(expiresDate.getHours() + 2);

                const bookingPayload = { 
                    status: 'pending', 
                    expiresAt: expiresDate, 
                    clientName: nameInput.value, 
                    clientPhone: phoneInput.value, 
                    type: bookingType,
                    price: currentBookingData.price,
                    userId: currentUser.uid 
                };

                try {
                    await setDoc(doc(db, 'schedules', currentBookingData.slotId), bookingPayload);
                    closeModal();
                    showToast('Seu horário foi pré-reservado! Você tem 2h para efetuar o pagamento.');
                } catch(e) {
                    console.error("Erro ao criar pré-reserva:", e);
                    showToast("Não foi possível fazer a pré-reserva.", false);
                }
            });
            
            cancelDeclineButton.addEventListener('click', closeCancelConfirmModal);
            cancelConfirmModal.addEventListener('click', e => { if (e.target === cancelConfirmModal) closeCancelConfirmModal(); });
            cancelConfirmButton.addEventListener('click', async () => {
                if (currentCancellationSlotId && schedules[currentCancellationSlotId]) {
                    try {
                        await deleteDoc(doc(db, 'schedules', currentCancellationSlotId));
                        closeCancelConfirmModal();
                        showToast('Pré-reserva cancelada com sucesso.');
                    } catch(e) {
                        console.error("Erro ao cancelar:", e);
                         showToast('Não foi possível cancelar.', false);
                    }
                }
            });

            searchInput.addEventListener('input', () => renderFilteredDays(searchInput.value));
            
            viewToggle.addEventListener('change', (e) => {
                isManagerView = e.target.checked;
                priceManagerContainer.classList.toggle('hidden', !isManagerView);
                nextEventDashboard.classList.toggle('hidden', !isManagerView);
                teamSorter.classList.toggle('hidden', isManagerView);
                renderBasedOnCurrentView();
                if (isManagerView) {
                    updateNextEventDashboard();
                } else {
                    clearInterval(dashboardInterval);
                }
            });

            // Demais event listeners (sem alterações)...
            priceManagerHeader.addEventListener('click', () => { /* ... */ });
            teamSorterHeader.addEventListener('click', () => { /* ... */ });
            addTypeSlotRadio.addEventListener('change', () => { /* ... */ });
            addTypeEventRadio.addEventListener('change', () => { /* ... */ });
            cancelAddSlotButton.addEventListener('click', closeAddSlotModal);
            addSlotModal.addEventListener('click', e => { if (e.target === addSlotModal) closeAddSlotModal(); });
            confirmAddSlotButton.addEventListener('click', () => { /* ... */ });
            integratePaymentBtn.addEventListener('click', openPaymentModal);
            cancelPaymentBtn.addEventListener('click', closePaymentModal);
            paymentModal.addEventListener('click', e => { if(e.target === paymentModal) closePaymentModal()});
            connectPaymentBtn.addEventListener('click', () => { /* ... */ });
            addPlayerBtn.addEventListener('click', addPlayerInput);
            sortTeamsBtn.addEventListener('click', () => { /* ... */ });
            
            // Inicialização
            initFirebase(); 
            initPriceManager();
            addPlayerInput();
            lucide.createIcons();
            setInterval(checkExpiredReservations, 60000); 
        });
    </script>
</body>
</html>

